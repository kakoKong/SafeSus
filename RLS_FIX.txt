ğŸ”’ RLS POLICY FIX FOR APPROVALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ THE ERROR
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Error approving submission: {
  code: '42501',
  message: 'new row violates row-level security policy for table "zones"'
}


ğŸ” ROOT CAUSE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
The zones and pins tables have Row Level Security (RLS) enabled,
but NO policies allowing admins to INSERT data.

When admin approves a submission:
1. API tries to INSERT into zones/pins table âŒ
2. RLS blocks the insert (no policy allows it) âŒ
3. Approval fails âŒ


âœ… THE SOLUTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Run the RLS policy migration to allow admins to:
â€¢ INSERT into zones table (for approved zone submissions)
â€¢ INSERT into pins table (for approved pin submissions)
â€¢ UPDATE submission tables (to mark as approved/rejected)
â€¢ VIEW all submissions (for admin dashboard)


ğŸ“‹ SETUP (RUN THIS MIGRATION)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Open Supabase SQL Editor and run:
scripts/fix-rls-for-approvals.sql

This script:
âœ… Allows admins to INSERT zones
âœ… Allows admins to INSERT pins
âœ… Allows admins to UPDATE zones
âœ… Allows admins to UPDATE pins
âœ… Allows admins to UPDATE submissions
âœ… Allows admins to VIEW all submissions


ğŸ“Š WHAT THE MIGRATION DOES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

For zones table:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OLD:                                                    â”‚
â”‚ â€¢ Public can SELECT (view) zones âœ…                     â”‚
â”‚ â€¢ No one can INSERT zones âŒ                            â”‚
â”‚                                                         â”‚
â”‚ NEW:                                                    â”‚
â”‚ â€¢ Public can SELECT (view) zones âœ…                     â”‚
â”‚ â€¢ Admins can INSERT zones âœ…                            â”‚
â”‚ â€¢ Admins can UPDATE zones âœ…                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

For pins table:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OLD:                                                    â”‚
â”‚ â€¢ Public can SELECT (view) pins âœ…                      â”‚
â”‚ â€¢ No one can INSERT pins âŒ                             â”‚
â”‚                                                         â”‚
â”‚ NEW:                                                    â”‚
â”‚ â€¢ Public can SELECT (view) pins âœ…                      â”‚
â”‚ â€¢ Admins can INSERT pins âœ…                             â”‚
â”‚ â€¢ Admins can UPDATE pins âœ…                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

For submission tables:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OLD:                                                    â”‚
â”‚ â€¢ Users can view own submissions âœ…                     â”‚
â”‚ â€¢ Guardians can view all submissions âœ…                 â”‚
â”‚ â€¢ No UPDATE policies âŒ                                 â”‚
â”‚                                                         â”‚
â”‚ NEW:                                                    â”‚
â”‚ â€¢ Users can view own submissions âœ…                     â”‚
â”‚ â€¢ Guardians can view all submissions âœ…                 â”‚
â”‚ â€¢ Admins can view all submissions âœ…                    â”‚
â”‚ â€¢ Admins can UPDATE submissions âœ…                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ğŸ”„ APPROVAL FLOW (AFTER FIX)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User submits zone
    â†“
zone_submissions table (pending)
    â†“
Admin clicks "Approve"
    â†“
API tries to INSERT into zones table
    â†“
RLS checks: Is user admin? âœ…
    â†“
INSERT succeeds! âœ…
    â†“
Zone appears on map! ğŸ‰


ğŸ” SECURITY MAINTAINED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Public can still only VIEW zones/pins
âœ… Only admins can INSERT/UPDATE zones/pins
âœ… Users can only see their own submissions
âœ… Guardians can view all submissions
âœ… Admins have full access to submissions
âœ… No security compromised!


ğŸ§ª TESTING AFTER MIGRATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Run the migration script

2. Test zone approval:
   â€¢ Submit a test zone (as user)
   â€¢ Approve it (as admin)
   â€¢ Should succeed! âœ…
   â€¢ Check map - zone should appear âœ…

3. Test pin approval:
   â€¢ Submit a test pin (as user)
   â€¢ Approve it (as admin)
   â€¢ Should succeed! âœ…
   â€¢ Check map - pin should appear âœ…

4. Verify RLS still works:
   â€¢ Try to insert zone as non-admin â†’ Blocked âœ…
   â€¢ Try to view as public â†’ Works âœ…


ğŸ” VERIFICATION QUERIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Check if policies exist:

-- Check zones policies
SELECT schemaname, tablename, policyname 
FROM pg_policies 
WHERE tablename = 'zones';

-- Check pins policies
SELECT schemaname, tablename, policyname 
FROM pg_policies 
WHERE tablename = 'pins';

-- Should show:
-- â€¢ Public can view zones
-- â€¢ Admins can insert zones
-- â€¢ Admins can update zones
-- â€¢ Public can view pins
-- â€¢ Admins can insert pins
-- â€¢ Admins can update pins


ğŸ“‹ COMPLETE MIGRATION SEQUENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Run these in order (if you haven't already):

1. scripts/add-verified-by-to-pins.sql
   (Adds columns for tracking approvals)

2. scripts/add-increment-score-function.sql
   (Adds function to award points)

3. scripts/fix-rls-for-approvals.sql  â† THIS ONE!
   (Fixes RLS policies)


ğŸš¨ TROUBLESHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Error: "new row violates row-level security policy"
Solution: Run fix-rls-for-approvals.sql

Error: "permission denied for table zones"
Solution: Make sure you're admin in user_profiles table

Error: "duplicate key value violates unique constraint"
Solution: Policy already exists, safe to ignore


âœ… SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEM:
RLS policies blocked admin inserts into zones/pins tables

SOLUTION:
Add policies allowing admins to INSERT and UPDATE

RESULT:
âœ… Admins can approve submissions
âœ… Approved content appears on map
âœ… Security maintained
âœ… Everything works!


ğŸ‰ READY TO FIX!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Just run this in Supabase SQL Editor:
scripts/fix-rls-for-approvals.sql

Then test the approval workflow again!

